<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google 風格行事曆</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .calendar-grid {
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        .day-cell {
            min-height: 120px;
        }
        .event-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        /* Google 配色 */
        .event-google-blue { background-color: #4285F4; }
        .event-google-green { background-color: #34A853; }
        .event-google-yellow { background-color: #FBBC05; }
        .event-google-red { background-color: #EA4335; }
        
        /* 跨日活動連線樣式 */
        .event-bar {
            height: 24px;
            margin-bottom: 2px;
            font-size: 11px;
            display: flex;
            align-items: center;
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .event-bar:hover { opacity: 0.85; }
        .event-start { border-top-left-radius: 4px; border-bottom-left-radius: 4px; margin-left: 4px; padding-left: 8px; }
        .event-end { border-top-right-radius: 4px; border-bottom-right-radius: 4px; margin-right: 4px; }
        .event-mid { border-radius: 0; margin-left: 0; margin-right: 0; }
        .event-single { border-radius: 4px; margin-left: 4px; margin-right: 4px; padding-left: 8px; }

        /* 響應式調整 */
        @media (max-width: 768px) {
            .day-cell { min-height: 100px; }
        }
        @media (max-width: 640px) {
            .day-cell { min-height: 80px; padding: 0.1rem; }
            .event-bar { height: 18px; font-size: 9px; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="flex flex-col md:flex-row md:h-screen">
        <!-- 左側邊欄 -->
        <aside class="w-full md:w-64 flex-shrink-0 bg-white border-b md:border-r md:border-b-0 border-gray-200 p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-8">行事曆</h1>
            <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wider mb-4">活動類型</h2>
            <div id="event-filter" class="space-y-3">
                <div>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" data-event-type="TRBB" class="form-checkbox h-5 w-5 text-blue-600 rounded" checked>
                        <span class="event-dot event-google-blue"></span>
                        <span>TRBB 專屬活動</span>
                    </label>
                </div>
                <div>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" data-event-type="sign" class="form-checkbox h-5 w-5 text-red-600 rounded" checked>
                        <span class="event-dot event-google-red"></span>
                        <span>團報提醒</span>
                    </label>
                </div>
                <div>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" data-event-type="competition" class="form-checkbox h-5 w-5 text-yellow-600 rounded" checked>
                         <span class="event-dot event-google-yellow"></span>
                        <span>三鐵競賽</span>
                    </label>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            <header class="flex flex-wrap items-center justify-between gap-4 mb-8">
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <h2 id="current-month-year" class="text-xl sm:text-2xl font-semibold text-gray-700"></h2>
                    <button id="next-month" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
                <button id="today-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition-colors">今天</button>
            </header>

            <!-- 桌面網格 -->
            <div id="calendar-grid-container" class="hidden md:block bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="grid calendar-grid border-b border-gray-200">
                    <div class="text-center py-3 text-xs sm:text-sm font-medium text-gray-500">一</div>
                    <div class="text-center py-3 text-xs sm:text-sm font-medium text-gray-500">二</div>
                    <div class="text-center py-3 text-xs sm:text-sm font-medium text-gray-500">三</div>
                    <div class="text-center py-3 text-xs sm:text-sm font-medium text-gray-500">四</div>
                    <div class="text-center py-3 text-xs sm:text-sm font-medium text-gray-500">五</div>
                    <div class="text-center py-3 text-xs sm:text-sm font-medium text-gray-500 text-blue-500 font-bold">六</div>
                    <div class="text-center py-3 text-xs sm:text-sm font-medium text-gray-500 text-red-500 font-bold">日</div>
                </div>
                <div id="calendar-body" class="grid calendar-grid"></div>
            </div>

            <!-- 手機列表 -->
            <div id="calendar-list-view" class="block md:hidden bg-white rounded-lg shadow-sm border border-gray-200"></div>
        </main>
    </div>

    <!-- Modal -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md relative">
            <button id="modal-close-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800"></h3>
            <div id="modal-info-section" class="space-y-3 text-gray-700 text-sm">
                <p><strong class="font-semibold w-16 inline-block">日期：</strong> <span id="modal-date"></span></p>
                <p><strong class="font-semibold w-16 inline-block">時間：</strong> <span id="modal-time"></span></p>
                <p><strong class="font-semibold w-16 inline-block">地點：</strong> <span id="modal-location"></span></p>
                <!-- 狀態標籤 -->
                <p id="modal-status-wrapper" class="hidden">
                    <strong class="font-semibold w-16 inline-block">狀態：</strong> 
                    <span id="modal-status-tag" class="px-2 py-1 rounded text-xs font-bold"></span>
                </p>
            </div>
            <div class="mt-6 space-y-2">
                <a href="#" id="modal-link-btn" target="_blank" class="hidden inline-block w-full text-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors shadow-sm">前往報名</a>
                <a href="#" id="modal-web-btn" target="_blank" class="hidden inline-block w-full text-center px-4 py-3 bg-gray-100 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-200 font-semibold transition-colors">前往官網</a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const calendarBody = document.getElementById('calendar-body');
            const listViewContainer = document.getElementById('calendar-list-view');
            const currentMonthYear = document.getElementById('current-month-year');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const todayBtn = document.getElementById('today-btn');
            const filterContainer = document.getElementById('event-filter');
            
            const eventModal = document.getElementById('event-modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalTitle = document.getElementById('modal-title');
            const modalInfoSection = document.getElementById('modal-info-section');
            const modalDate = document.getElementById('modal-date');
            const modalTime = document.getElementById('modal-time');
            const modalLocation = document.getElementById('modal-location');
            const modalStatusWrapper = document.getElementById('modal-status-wrapper');
            const modalStatusTag = document.getElementById('modal-status-tag');
            const modalLinkBtn = document.getElementById('modal-link-btn');
            const modalWebBtn = document.getElementById('modal-web-btn');

            let currentDate = new Date();
            let currentMonth = currentDate.getMonth();
            let currentYear = currentDate.getFullYear();
            
            const googleSheetURL = 'https://docs.google.com/spreadsheets/d/1OYYQG5qsVK39IY1sDbu0iqdDktGGQsF3CQOX9isrrVg/export?format=csv';
            let events = [];

            const typeColors = { TRBB: 'google-blue', sign: 'google-red', competition: 'google-yellow' };

            async function fetchEventsFromSheet(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('網路錯誤');
                    const csvText = await response.text();
                    const lines = csvText.trim().split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    const idx = {
                        date: headers.indexOf('date'),
                        title: headers.indexOf('title'),
                        type: headers.indexOf('type'),
                        time: headers.indexOf('time'),
                        loc: headers.indexOf('location'),
                        url: headers.indexOf('url'),
                        web: headers.indexOf('web'),
                        end: headers.indexOf('endDate'),
                        status: headers.indexOf('status') // 新增狀態欄位索引
                    };

                    return lines.slice(1).map(line => {
                        const v = line.split(',').map(s => s.trim());
                        if (v.length < 3) return null;
                        const start = parseDate(v[idx.date]);
                        const end = idx.end > -1 && v[idx.end] ? parseDate(v[idx.end]) : new Date(start);
                        return {
                            start, end,
                            title: v[idx.title],
                            type: v[idx.type],
                            time: v[idx.time] || '未提供',
                            location: v[idx.loc] || '未提供',
                            url: v[idx.url] || '',
                            web: v[idx.web] || '',
                            status: idx.status > -1 ? v[idx.status] : '' // 新增狀態資料
                        };
                    }).filter(e => e && e.title);
                } catch (e) {
                    console.error(e);
                    return [];
                }
            }

            function parseDate(s) {
                const parts = s.split('-');
                return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            }

            function isSameDay(d1, d2) {
                return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
            }

            function getSelectedEventTypes() {
                return Array.from(filterContainer.querySelectorAll('input:checked')).map(cb => cb.dataset.eventType);
            }

            function openModal(event) {
                modalTitle.textContent = event.title;
                
                // 如果是團報，隱藏日期時間地點
                if (event.type === 'sign') {
                    modalInfoSection.classList.add('hidden');
                } else {
                    modalInfoSection.classList.remove('hidden');
                    const dateStr = isSameDay(event.start, event.end) ? 
                        event.start.toLocaleDateString('zh-TW') : 
                        `${event.start.toLocaleDateString('zh-TW')} - ${event.end.toLocaleDateString('zh-TW')}`;
                    modalDate.textContent = dateStr;
                    modalTime.textContent = event.time;
                    modalLocation.textContent = event.location;

                    // 處理狀態標籤
                    if (event.status) {
                        modalStatusWrapper.classList.remove('hidden');
                        modalStatusTag.textContent = event.status;
                        
                        // 重置樣式
                        modalStatusTag.className = "px-2 py-1 rounded text-xs font-bold ";
                        
                        // 根據文字判斷顏色
                        if (event.status === '團報截止') {
                            modalStatusTag.classList.add('bg-yellow-100', 'text-yellow-800');
                        } else if (event.status === '沒有團報') {
                            modalStatusTag.classList.add('bg-gray-100', 'text-gray-800');
                        } else if (event.status === '團報中') {
                            modalStatusTag.classList.add('bg-green-100', 'text-green-800');
                        } else {
                            // 預設顏色
                            modalStatusTag.classList.add('bg-blue-100', 'text-blue-800');
                        }
                    } else {
                        modalStatusWrapper.classList.add('hidden');
                    }
                }
                
                // 處理報名按鈕 (url 欄位)
                if (event.url) {
                    modalLinkBtn.href = event.url;
                    modalLinkBtn.textContent = event.type === 'TRBB' ? '【前往報名】' : '前往報名';
                    modalLinkBtn.classList.remove('hidden');
                } else {
                    modalLinkBtn.classList.add('hidden');
                }

                // 處理官網按鈕 (web 欄位)
                if (event.web) {
                    modalWebBtn.href = event.web;
                    modalWebBtn.classList.remove('hidden');
                } else {
                    modalWebBtn.classList.add('hidden');
                }

                eventModal.classList.replace('hidden', 'flex');
            }

            function generateGridView(month, year) {
                calendarBody.innerHTML = '';
                const firstDayOfMonth = new Date(year, month, 1);
                const startOffset = (firstDayOfMonth.getDay() + 6) % 7;
                const daysInMonth = 32 - new Date(year, month, 32).getDate();
                const today = new Date();
                today.setHours(0,0,0,0);

                const calendarDays = [];
                for (let i = 0; i < startOffset; i++) calendarDays.push(null);
                for (let i = 1; i <= daysInMonth; i++) calendarDays.push(new Date(year, month, i));

                const selectedTypes = getSelectedEventTypes();
                // 排序：多日活動優先排在上方
                const activeEvents = events.filter(e => selectedTypes.includes(e.type))
                    .sort((a, b) => (b.end - b.start) - (a.end - a.start) || a.start - b.start);

                for (let i = 0; i < calendarDays.length; i += 7) {
                    const weekDays = calendarDays.slice(i, i + 7);
                    const weekSlots = []; 

                    weekDays.forEach((day, dayIdx) => {
                        if (!day) {
                            calendarBody.innerHTML += `<div class="day-cell border-r border-b border-gray-200 bg-gray-50/50"></div>`;
                            return;
                        }

                        const isToday = isSameDay(day, today);
                        const isPast = day < today;
                        let cellHTML = `<div class="day-cell relative border-r border-b border-gray-200 flex flex-col ${isPast ? 'bg-gray-100' : 'hover:bg-gray-50 transition-colors'}">
                            <span class="text-xs p-2 self-start ${isToday ? 'bg-blue-600 text-white rounded-full h-6 w-6 flex items-center justify-center font-bold shadow-sm' : (isPast ? 'text-gray-400' : 'text-gray-600')}">${day.getDate()}</span>
                            <div class="event-stack space-y-0.5 mt-1">`;

                        const dayEvents = activeEvents.filter(e => day >= e.start && day <= e.end);
                        
                        const renderedSlots = [];
                        dayEvents.forEach(event => {
                            let slot = weekSlots.findIndex(s => s && s.title === event.title);
                            if (slot === -1) {
                                slot = weekSlots.findIndex(s => s === undefined);
                                if (slot === -1) slot = weekSlots.length;
                                weekSlots[slot] = event;
                            }
                            renderedSlots[slot] = event;
                        });

                        for (let s = 0; s < Math.max(weekSlots.length, 3); s++) {
                            const event = renderedSlots[s];
                            if (!event) {
                                cellHTML += `<div class="h-6"></div>`;
                                continue;
                            }

                            const isStart = isSameDay(day, event.start) || dayIdx === 0;
                            const isEnd = isSameDay(day, event.end) || dayIdx === 6;
                            const isSingle = isSameDay(event.start, event.end);
                            
                            let barClass = "event-bar ";
                            if (isSingle) barClass += "event-single";
                            else if (isStart && isEnd) barClass += "event-single"; 
                            else if (isStart) barClass += "event-start";
                            else if (isEnd) barClass += "event-end";
                            else barClass += "event-mid";

                            const color = typeColors[event.type] || 'google-blue';
                            const colorClass = `bg-${color.split('-')[1]}-500 text-white`;

                            const showText = isStart;
                            const eventIndex = events.indexOf(event);

                            cellHTML += `<div data-index="${eventIndex}" class="${barClass} ${colorClass} ${isPast ? 'opacity-60' : 'shadow-sm'} font-medium">
                                ${showText ? `<span class="truncate px-1">${event.title}</span>` : ''}
                            </div>`;
                        }

                        cellHTML += `</div></div>`;
                        calendarBody.innerHTML += cellHTML;
                    });
                    
                    weekSlots.forEach((event, idx) => {
                        if (event && weekDays[6] && weekDays[6] >= event.end) weekSlots[idx] = undefined;
                    });
                }
            }

            function generateListView(month, year) {
                listViewContainer.innerHTML = '';
                const selectedTypes = getSelectedEventTypes();
                const today = new Date();
                today.setHours(0,0,0,0);
                
                const monthEvents = events.filter(e => 
                    selectedTypes.includes(e.type) && 
                    ((e.start.getMonth() === month && e.start.getFullYear() === year) || 
                     (e.end.getMonth() === month && e.end.getFullYear() === year))
                ).sort((a,b) => a.start - b.start);

                if (monthEvents.length === 0) {
                    listViewContainer.innerHTML = '<p class="text-center text-gray-500 p-8">本月無活動安排</p>';
                    return;
                }

                monthEvents.forEach(event => {
                    const isPast = event.end < today;
                    const eventIndex = events.indexOf(event);
                    const color = typeColors[event.type] || 'google-blue';
                    const bgColor = `bg-${color.split('-')[1]}-100`;
                    const textColor = `text-${color.split('-')[1]}-800`;
                    
                    listViewContainer.innerHTML += `
                        <div data-index="${eventIndex}" class="event-item p-4 border-b flex items-start space-x-4 cursor-pointer hover:bg-gray-50 transition-colors ${isPast ? 'opacity-50' : ''}">
                            <div class="text-center w-12 flex-shrink-0">
                                <p class="text-[10px] text-gray-400 font-bold">${event.start.getMonth()+1}/${event.start.getDate()}</p>
                                <p class="text-lg font-bold leading-none my-1">~</p>
                                <p class="text-[10px] text-gray-400 font-bold">${event.end.getMonth()+1}/${event.end.getDate()}</p>
                            </div>
                            <div class="flex-grow p-3 rounded-lg ${bgColor} ${textColor} border border-${color.split('-')[1]}-200">
                                <p class="font-bold text-sm">${event.title}</p>
                                <p class="text-xs mt-1 opacity-80">${event.time} @ ${event.location}</p>
                            </div>
                        </div>`;
                });
            }
            
            function render(m, y) {
                currentMonthYear.textContent = `${y} 年 ${m + 1} 月`;
                generateGridView(m, y);
                generateListView(m, y);
            }

            const handleEventClick = (e) => {
                const el = e.target.closest('[data-index]');
                if (el) openModal(events[el.dataset.index]);
            };

            calendarBody.addEventListener('click', handleEventClick);
            listViewContainer.addEventListener('click', handleEventClick);
            modalCloseBtn.addEventListener('click', () => eventModal.classList.replace('flex', 'hidden'));
            
            prevMonthBtn.addEventListener('click', () => { currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} render(currentMonth,currentYear); });
            nextMonthBtn.addEventListener('click', () => { currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} render(currentMonth,currentYear); });
            todayBtn.addEventListener('click', () => { const t=new Date(); currentMonth=t.getMonth(); currentYear=t.getFullYear(); render(currentMonth,currentYear); });
            filterContainer.addEventListener('change', () => render(currentMonth,currentYear));

            events = await fetchEventsFromSheet(googleSheetURL);
            render(currentMonth, currentYear);
        });
    </script>
</body>
</html>
